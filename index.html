<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecobee Data Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 100px;
        }

        #loader {
            display: none;
            margin-top: 20px;
            font-size: 18px;
            color: green;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Export Ecobee Data</h1>
    <!-- <button onclick="exportData()">Export Ecobee Data</button>
    <div id="loader">In Progress...</div> -->
    <!-- <button id="loadingButton" class="btn btn-primary" type="button" onclick="exportData()">
        <span id="buttonLoader" class="spinner-border spinner-border-sm me-2" aria-hidden="true"
            style="display: none;"></span>
        <span id="buttonText">Export Ecobee Data</span>
    </button> -->
    <button id="loadingButton" class="btn btn-primary" type="button" onclick="exportData()">
        <span id="buttonLoader" class="spinner-border spinner-border-sm me-2" aria-hidden="true"
            style="display: none;"></span>
        <span id="buttonText">Export Ecobee Data</span>
    </button>
    <script>
        let isLoading = false;
        function exportData() {
            if (isLoading === true) {
                alert('Already in progress!');
                return;
            }
            isLoading = true;
            // Show loader and update button
            updateButtonState();
            // document.getElementById('loader').style.display = 'block';
            fetch('/export-ecobee')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ecobee_device_status.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    isLoading = false; // Reset loading
                    updateButtonState();
                    // document.getElementById('loader').style.display = 'none';
                    alert('Download Completed!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Something went wrong!');
                    // document.getElementById('loader').style.display = 'none';
                    isLoading = false; // Reset loading
                    updateButtonState();
                });
        }

        function updateButtonState() {
            const button = document.getElementById('loadingButton');
            const loader = document.getElementById('buttonLoader');
            const buttonText = document.getElementById('buttonText');

            if (isLoading) {
                // ✅ Loader visible, disable button
                loader.style.display = 'inline-block';
                buttonText.innerText = 'Loading...';
                button.disabled = true;
            } else {
                // ✅ Loader hidden, enable button
                loader.style.display = 'none';
                buttonText.innerText = 'Export Ecobee Data';
                button.disabled = false;
            }
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
        crossorigin="anonymous"></script>
</body>

</html>